\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}

\renewcommand{\baselinestretch}{1.1}
\usepackage{geometry}
\geometry{letterpaper}
\usepackage[parfill]{parskip}
\usepackage{graphicx}

% Essential Packages
\usepackage{makeidx}
\makeindex
\usepackage{enumitem}
\usepackage[T1]{fontenc}
\usepackage{natbib}
\bibliographystyle{apalike}
\usepackage{ragged2e}
\usepackage{etoolbox}
\usepackage{amssymb}
\usepackage{eso-pic}
\usepackage{fontawesome}
\usepackage{todonotes}
\usepackage{apptools, chngcntr}
\usepackage{amsmath}
\usepackage{mathrsfs}
\usepackage{stmaryrd}
\usepackage{mathtools}
\usepackage{tocloft}
\usepackage{xparse}
\usepackage{tkz-euclide}
\usetkzobj{all}
\usepackage[utf8]{inputenc}
\usepackage{csquotes}
\usepackage[english]{babel}
\usepackage{marvosym}
\usepackage{pgf,tikz}
\usepackage{tikz-cd}
\usepackage{pgfplots}
\usepackage{fancyhdr}
\usepackage{array}
\usepackage{faktor}
\usepackage{float}
\usepackage{xcolor}
\usepackage{centernot}
\usepackage{silence}
  \WarningFilter*{latex}{Marginpar on page \thepage\space moved}
\usepackage{tcolorbox}
\tcbuselibrary{skins,breakable}
\usepackage{longtable,booktabs}
\usepackage[amsmath,hyperref,thmmarks]{ntheorem}
\usepackage{thmtools}
\usepackage{hyperref}
\usepackage[noabbrev,capitalize,nameinlink]{cleveref}

% xcolor (scheme: base16 eighties)
\definecolor{dark}{HTML}{2D2D2D}
\definecolor{light}{HTML}{D3D0C8}
\definecolor{be-red}{HTML}{F47678}
\definecolor{be-green}{HTML}{98CD97}
\definecolor{be-yellow}{HTML}{E2B552}
\definecolor{be-blue}{HTML}{6498CE}
\definecolor{be-magenta}{HTML}{CD98CD}
\definecolor{be-cyan}{HTML}{61CCCD}
\definecolor{be-gray}{HTML}{747369}
\definecolor{be-brown}{HTML}{D47B4E}

% \definecolor{dark}{HTML}{FFF3CB}
% \definecolor{light}{HTML}{010101}

% hyperref Package Settings
\hypersetup{
    unicode=true,          % non-Latin characters in Acrobat’s bookmarks
    pdftoolbar=false,        % show Acrobat’s toolbar?
    pdfmenubar=false,        % show Acrobat’s menu?
    pdffitwindow=true,     % window fit to page when opened
    colorlinks=true,
    allcolors=be-magenta,
}

% tikz
\usepgfplotslibrary{polar}
\usepgflibrary{shapes.geometric}
\usetikzlibrary{angles,patterns,calc,decorations.markings,arrows.meta,tikzmark,bending}
\tikzset{midarrow/.style 2 args={
        decoration={markings,
            mark= at position #2 with {\arrow{#1}} ,
        },
        postaction={decorate}
    },
    midarrow/.default={latex}{0.5}
}
\def\centerarc[#1](#2)(#3:#4:#5)% Syntax: [draw options] (center) (initial angle:final angle:radius)
    { \draw[#1] ($(#2)+({#5*cos(#3)},{#5*sin(#3)})$) arc (#3:#4:#5); }

% enumitems
\newlist{inlinelist}{enumerate*}{1}
\setlist*[inlinelist,1]{%
  label=(\roman*),
}

% Theorem Style Customization
\setlength\theorempreskipamount{2ex}
\setlength\theorempostskipamount{3ex}

\makeatletter
\let\nobreakitem\item
\let\@nobreakitem\@item
\patchcmd{\nobreakitem}{\@item}{\@nobreakitem}{}{}
\patchcmd{\nobreakitem}{\@item}{\@nobreakitem}{}{}
\patchcmd{\@nobreakitem}{\@itempenalty}{\@M}{}{}
\patchcmd{\@xthm}{\ignorespaces}{\nobreak\ignorespaces}{}{}
\patchcmd{\@ythm}{\ignorespaces}{\nobreak\ignorespaces}{}{}

\renewtheoremstyle{break}%
  {\item{\theorem@headerfont
          ##1\ ##2\theorem@separator}\hskip\labelsep\relax\nobreakitem}%
  {\item{\theorem@headerfont
          ##1\ ##2\ (##3)\theorem@separator}\hskip\labelsep\relax\nobreakitem}
\makeatother

% ntheorem + framed
\makeatletter

% ntheorem Declarations
\theorempreskip{10pt}
\theorempostskip{5pt}
\theoremstyle{break}

\theoremsymbol{\faComment}
\newtheorem{remark}{Remark}[section]
\theoremsymbol{}
\newtheorem{ex}{Exercise}[section]
\theorembodyfont{\normalfont}
\newtheorem*{solution}{\faPencil $\enspace$ Solution}
\theoremsymbol{\faGavel}
\newtheorem{eg}{Example}[section]
\theorembodyfont{\it}
\theoremsymbol{}

    % definition env
\theoremprework{\textcolor{be-blue}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-blue}\normalfont\bfseries}
\theorempostwork{\textcolor{be-blue}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem{defn}{\faBook \enspace Definition}

    % definition env no num
\theoremprework{\textcolor{be-blue}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-blue}\normalfont\bfseries}
\theorempostwork{\textcolor{be-blue}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{defnnonum}{\faBook \enspace Definition}

\theoremprework{\textcolor{be-blue}{\hrule height 2pt width \marginparwidth}}
\theoremheaderfont{\color{be-blue}\normalfont\bfseries}
\theorempostwork{\textcolor{be-blue}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem{margindefn}[defn]{\faBook \enspace Definition}

\theoremprework{\textcolor{be-blue}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-blue}\normalfont\bfseries}
\theorempostwork{\textcolor{be-blue}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{margindefnnonum}{\faBook \enspace Definition}

    % theorem envs
\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-magenta}\normalfont\bfseries}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem{thm}{\faCoffee \enspace Theorem}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem{propo}[thm]{\faTint \enspace Proposition}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem{crly}[thm]{\faSpaceShuttle \enspace Corollary}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem{lemma}[thm]{\faTree \enspace Lemma}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem{axiom}[thm]{\faShield \enspace Axiom}

    % theorem envs without counter
\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-magenta}\normalfont\bfseries}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{thmnonum}{\faCoffee \enspace Theorem}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{propononum}{\faTint \enspace Proposition}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{crlynonum}{\faSpaceShuttle \enspace Corollary}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{lemmanonum}{\faTree \enspace Lemma}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{axiomnonum}{\faShield \enspace Axiom}

    % envs on margins
\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremheaderfont{\color{be-magenta}\normalfont\bfseries}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem{marginthm}[thm]{\faCoffee \enspace Theorem}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem{marginpropo}[thm]{\faTint \enspace Proposition}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem{margincrly}[thm]{\faSpaceShuttle \enspace Corollary}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem{marginlemma}[thm]{\faTree \enspace Lemma}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem{marginaxiom}[thm]{\faShield \enspace Axiom}

    % envs on margins without counter
\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremheaderfont{\color{be-magenta}\normalfont\bfseries}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem*{marginthmnonum}{\faCoffee \enspace Theorem}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem*{marginpropononum}{\faTint \enspace Proposition}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem*{margincrlynonum}{\faSpaceShuttle \enspace Corollary}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem*{marginlemmanonum}{\faTree \enspace Lemma}

\theoremprework{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theorempostwork{\textcolor{be-magenta}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem*{marginaxiomnonum}{\faShield \enspace Axiom}

    % proof env
\theoremprework{\textcolor{be-brown}{\hrule height 2pt width \textwidth}}
\theorembodyfont{\normalfont}
\theoremheaderfont{\color{be-brown}\normalfont\bfseries}
\theorempostwork{\textcolor{be-brown}{\hrule height 2pt width \textwidth}}
\theoremsymbol{\ensuremath{_\square}}
\newtheorem*{proof}{\faPencil \enspace Proof}
\theoremsymbol{}

    % note and notation env
\theorembodyfont{\it}

\theoremprework{\textcolor{be-yellow}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-yellow}\normalfont\bfseries}
\theorempostwork{\textcolor{be-yellow}{\hrule height 2pt width \textwidth}}
\newtheorem{note}{\faQuoteLeft \enspace Note}[section]

\theoremprework{\textcolor{be-yellow}{\hrule height 2pt width \marginparwidth}}
\theoremheaderfont{\color{be-yellow}\normalfont\bfseries}
\theorempostwork{\textcolor{be-yellow}{\hrule height 2pt width \marginparwidth}}
\newtheorem{mnote}[note]{\faQuoteLeft \enspace Note}

\theoremprework{\textcolor{be-yellow}{\hrule height 2pt width \textwidth}}
\theorempostwork{\textcolor{be-yellow}{\hrule height 2pt width \textwidth}}
\newtheorem*{notation}{\faPaw \enspace Notation}

    % warning env
\theoremprework{\textcolor{be-red}{\hrule height 2pt width \textwidth}}
\theoremheaderfont{\color{be-red}\normalfont\bfseries}
\theorempostwork{\textcolor{be-red}{\hrule height 2pt width \textwidth}}
\theoremindent10pt
\newtheorem*{warning}{\faBug \enspace Warning}

\theoremprework{\textcolor{be-red}{\hrule height 2pt width \marginparwidth}}
\theoremheaderfont{\color{be-red}\normalfont\bfseries}
\theorempostwork{\textcolor{be-red}{\hrule height 2pt width \marginparwidth}}
\theoremindent10pt
\newtheorem*{marginwarning}{\faBug \enspace Warning}

% rule for appendices
\AtAppendix{\counterwithin{defn}{chapter}}
\AtAppendix{\counterwithin{thm}{chapter}}
\AtAppendix{\counterwithin{propo}{chapter}}
\AtAppendix{\counterwithin{lemma}{chapter}}
\AtAppendix{\counterwithin{crly}{chapter}}
\AtAppendix{\counterwithin{axiom}{chapter}}

% more environments
\newtcolorbox{quotebox}[2]{
  blanker,enhanced,breakable,standard jigsaw,
  opacityback=0,
  coltext=\ifblank{#2}{dark}{#2},
  left=5mm,right=5mm,top=2mm,bottom=2mm,
  colframe=\ifblank{#1}{be-gray}{#1},
  boxrule=0pt,leftrule=3pt,
  fontupper=\itshape
}

\providecommand{\parthook}{}
\patchcmd{\part}{\thispagestyle}{\parthook\thispagestyle}{}{}
\newcommand{\partimage}[2][]{% \parthook[<options>]{<image>}
  \renewcommand{\parthook}{% Update \parthook
    \AddToShipoutPictureBG*{% Add picture to background of THIS page only
      \AtPageLowerLeft{\includegraphics[width=\paperwidth,height=\paperheight,#1]{#2}}}% Insert image
    \renewcommand{\parthook}{}}}% Restore \parthook

\AtBeginDocument{\renewcommand\contentsname{\slshape Table of Contents\normalfont}}
\cftpagenumbersoff{part}

\newcommand{\tuftepart}[1]{\newgeometry{}\part{#1}\restoregeometry}

% Heading formattings
% chapter format
\titleformat{\chapter}%
  {\huge\rmfamily\itshape\color{be-magenta}}% format applied to label+text
  {\llap{\colorbox{be-magenta}{\parbox{1.5cm}{\hfill\itshape\huge\textcolor{dark}{\thechapter}}}}}% label
  {5pt}% horizontal separation between label and title body
  {}% before the title body
  []% after the title body

% section format
\titleformat{\section}%
  {\normalfont\Large\rmfamily\itshape\color{be-blue}}% format applied to label+text
  {\llap{\colorbox{be-blue}{\parbox{1.5cm}{\hfill\itshape\textcolor{dark}{\thesection}}}}}% label
  {5pt}% horizontal separation between label and title body
  {}% before the title body
  []% after the title body

% subsection format
\titleformat{\subsection}%
  {\normalfont\large\itshape\color{be-green}}% format applied to label+text
  {\llap{\colorbox{be-green}{\parbox{1.5cm}{\hfill\textcolor{dark}{\thesubsection}}}}}% label
  {1em}% horizontal separation between label and title body
  {}% before the title body
  []% after the title body

% subsubsection format
\titleclass{\subsubsection}{straight}
\titleformat{\subsubsection}%
  {\normalfont\large\itshape\color{be-yellow}}% format applied to label+text
  {\llap{\colorbox{be-yellow}{\parbox{1.5cm}{\hfill\textcolor{dark}{\thesubsubsection}}}}}% label
  {1em}% horizontal separation between label and title body
  {}% before the title body
  []% after the title body

% Sidenote enhancements
\def\mathmarginnote#1{%
  \tag*{\rlap{\hspace\marginparsep\smash{\parbox[t]{\marginparwidth}{%
  \footnotesize#1}}}}
}

% Custom table columning
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

% Custom math operator
% \DeclareMathOperator{\rem}{rem}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator{\re}{Re}
\DeclareMathOperator{\im}{Im}
\DeclareMathOperator{\caparg}{Arg}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\Res}{Res}

% Graph styles
\pgfplotsset{compat=1.15}
\usepgfplotslibrary{fillbetween}
\pgfplotsset{four quads/.append style={axis x line=middle, axis y line=
middle, xlabel={$x$}, ylabel={$y$}, axis equal }}
\pgfplotsset{four quad complex/.append style={axis x line=middle, axis y line=
middle, xlabel={$\re$}, ylabel={$\im$}, axis equal }}
\def\axisdefaultwidth{360pt}
\pgfplotsset{
  tufteaxis/.append style = {thick},tick style = {thick,black},
  %
  % #1 = x, y, or z
  % #2 = the shift value
  /tikz/normal shift/.code 2 args = {%
    \pgftransformshift{%
        \pgfpointscale{#2}{\pgfplotspointouternormalvectorofticklabelaxis{#1}}%
    }%
  },%
  %
  range3frame/.style = {
    tick align        = outside,
    scaled ticks      = false,
    enlargelimits     = false,
    ticklabel shift   = {10pt},
    axis lines*       = left,
    line cap          = round,
    clip              = false,
    xtick style       = {normal shift={x}{10pt}},
    ytick style       = {normal shift={y}{10pt}},
    ztick style       = {normal shift={z}{10pt}},
    x axis line style = {normal shift={x}{10pt}},
    y axis line style = {normal shift={y}{10pt}},
    z axis line style = {normal shift={z}{10pt}},
  }
}

% Shortcuts
\newcommand{\floor}[1]{\lfloor #1 \rfloor}      % simplifying the writing of a floor function
\newcommand{\ceiling}[1]{\lceil #1 \rceil}      % simplifying the writing of a ceiling function
\newcommand{\dotp}{\, \cdotp}			        % dot product to distinguish from \cdot
\newcommand{\abs}[1]{\left|#1\right|}						% absolute value
\newcommand{\lra}[1]{\left\langle \; #1 \; \right\rangle}
\newcommand{\at}[2]{\Big|_{#1}^{#2}}
\newcommand{\Arg}[1]{\caparg #1}
\renewcommand{\bar}[1]{\mkern 1.5mu \overline{\mkern -1.5mu #1 \mkern -1.5mu} \mkern 1.5mu}
\newcommand{\quotient}[2]{\faktor{#1}{#2}}
\newcommand{\cyclic}[1]{\left\langle #1 \right\rangle}
	% highlighting shortcuts
\newcommand{\hlimpo}[1]{\textcolor{be-red}{\textbf{#1}}}
\newcommand{\hlwarn}[1]{\textcolor{be-yellow}{\textbf{#1}}}
\newcommand{\hldefn}[1]{\textcolor{be-blue}{\index{#1}\textbf{#1}}}
\newcommand{\hlnotea}[1]{\textcolor{be-green}{\textbf{#1}}}
\newcommand{\hlnoteb}[1]{\textcolor{be-cyan}{\textbf{#1}}}
\newcommand{\hlnotec}[1]{\textcolor{be-brown}{\textbf{#1}}}
\newcommand{\hlb}[2]{\colorbox{#1!30!dark}{\textbf{#2}}}
\newcommand{\hlbnotea}[1]{\hlb{be-green}{#1}}
\newcommand{\hlbnoteb}[1]{\hlb{be-cyan}{#1}}
\newcommand{\hlbnotec}[1]{\hlb{be-brown}{#1}}
\newcommand{\hlbnoted}[1]{\hlb{be-magenta}{#1}}
\newcommand{\hlbnotee}[1]{\hlb{be-red}{#1}}
\newcommand{\WTP}{\textcolor{be-brown}{WTP} }
\newcommand{\WTS}{\textcolor{be-brown}{WTS} }
\newcommand{\ind}[2]{\Ind_{#2}\left( #1 \right)}
\newcommand{\notimply}{\centernot\implies}
\newcommand{\res}[2]{\underset{#2}{\Res} #1 }
\newcommand{\tworow}[3]{\begin{tabular}{@{}#1@{}} #2 \\ #3 \end{tabular}}
\renewcommand{\epsilon}{\varepsilon}
\newcommand{\lrarrow}{\leftrightarrow}
\newcommand{\larrow}{\leftarrow}
\newcommand{\rarrow}{\rightarrow}
\renewcommand{\atop}[2]{\genfrac{}{}{0pt}{}{#1}{#2}}
\newcommand*\dif{\mathop{}\!d}
\newcommand{\mmid}{\; \middle| \;}
\newcommand{\coprime}{\; \bot \;}
\newcommand{\norm}[1]{\left\| #1 \right\|}

\DeclareMathOperator{\Img}{Img}

  % stars on important stuff
\newcommand{\imponote}{\faStar\ }
\newcommand{\vimponote}{\faStar\faStar\ }
\newcommand{\vvimponote}{\faStar\faStar\faStar\ }

  % inspiration from: https://tex.stackexchange.com/questions/8720/overbrace-underbrace-but-with-an-arrow-instead#37758
\newcommand{\overarrow}[2]{
  \overset{\makebox[0pt]{\begin{tabular}{@{}c@{}}#2\\[0pt]\ensuremath{\uparrow}\end{tabular}}}{\ensuremath{#1}}
}
\newcommand{\underarrow}[2]{
  \underset{\makebox[0pt]{\begin{tabular}{@{}c@{}}\downarrow\\[0pt]\ensuremath{#2}\end{tabular}}}{\ensuremath{#1}}
}

% Document header formatting
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}}
\makeatletter
\pagestyle{fancy}
\fancyhead{}
\fancyhead[RO]{\textsl{\@title} \enspace \thepage}
\fancyhead[LE]{\thepage \enspace \textsl{\leftmark \enspace - \enspace \rightmark}}
\makeatother

% Comment the two lines below if you want to print the document
\pagecolor{dark}
\color{light}
